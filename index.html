import React, { useState, useMemo, useEffect, useRef, useLayoutEffect } from 'react';
import { 
  Menu, X, Settings, FileCode, WrapText, GitCommit, Eye, ChevronDown, 
  Minus, Plus, ArrowRight, Code, Hash, Search, GitPullRequest, ArrowLeft, 
  Loader2, LogOut, Github, AlertCircle, ChevronUp, ChevronDown as ChevronDownIcon,
  RotateCcw, ExternalLink
} from 'lucide-react';

/**
 * --- GITHUB API UTILITIES ---
 */

const GITHUB_API_BASE = 'https://api.github.com';

const safeDecodeB64 = (str) => {
  try {
    return decodeURIComponent(escape(window.atob(str.replace(/\s/g, ''))));
  } catch (e) {
    console.error("Base64 Decode Error", e);
    return "Error decoding file content. It may be binary.";
  }
};

const fetchGitHub = async (endpoint, token) => {
  const response = await fetch(`${GITHUB_API_BASE}${endpoint}`, {
    headers: {
      Authorization: `token ${token}`,
      Accept: 'application/vnd.github.v3+json',
    },
  });
  
  if (!response.ok) {
    if (response.status === 401) throw new Error('Invalid Token');
    if (response.status === 403) throw new Error('Rate Limit Exceeded');
    if (response.status === 404) throw new Error('Not Found');
    throw new Error(`GitHub API Error: ${response.status}`);
  }
  return response.json();
};

/**
 * --- DIFF ALGORITHM ---
 */

const computeDiff = (oldText = "", newText = "") => {
  if (!oldText && !newText) return [];
  
  const lines1 = oldText.split('\n');
  const lines2 = newText.split('\n');
  
  if (lines1.length > 2000 || lines2.length > 2000) {
    return [{ type: 'equal', text: 'File too large to diff in browser.', oldLine: 1, newLine: 1 }];
  }

  const matrix = Array(lines1.length + 1).fill(null).map(() => Array(lines2.length + 1).fill(0));

  for (let i = 1; i <= lines1.length; i++) {
    for (let j = 1; j <= lines2.length; j++) {
      if (lines1[i - 1] === lines2[j - 1]) {
        matrix[i][j] = matrix[i - 1][j - 1] + 1;
      } else {
        matrix[i][j] = Math.max(matrix[i - 1][j], matrix[i][j - 1]);
      }
    }
  }

  const result = [];
  let i = lines1.length, j = lines2.length;
  
  while (i > 0 || j > 0) {
    if (i > 0 && j > 0 && lines1[i - 1] === lines2[j - 1]) {
      result.unshift({ type: 'equal', text: lines1[i - 1], oldLine: i, newLine: j });
      i--; j--;
    } else if (j > 0 && (i === 0 || matrix[i][j - 1] >= matrix[i - 1][j])) {
      result.unshift({ type: 'add', text: lines2[j - 1], newLine: j });
      j--;
    } else {
      result.unshift({ type: 'remove', text: lines1[i - 1], oldLine: i });
      i--;
    }
  }
  return result;
};

const SyntaxText = ({ text }) => {
  if (!text) return null;
  const parts = text.split(/(\b(?:const|let|var|function|return|if|else|import|from|export|class|div|span|className|style)\b|'.*?'|".*?"|\/\/.*)/g);
  return (
    <>
      {parts.map((part, i) => {
        if (/^(const|let|var|function|return|if|else|import|from|export|class)$/.test(part)) return <span key={i} className="text-purple-400">{part}</span>;
        if (/^('.*?'|".*?")$/.test(part)) return <span key={i} className="text-green-400">{part}</span>;
        if (/^(\/\/.*)$/.test(part)) return <span key={i} className="text-slate-500">{part}</span>;
        if (/^(div|span|className|style)$/.test(part)) return <span key={i} className="text-blue-400">{part}</span>;
        return <span key={i}>{part}</span>;
      })}
    </>
  );
};

/**
 * --- SUB-COMPONENTS ---
 */

const LoginView = ({ onLogin, loading, error }) => {
  const [token, setToken] = useState(() => localStorage.getItem('gh_diff_token') || '');
  
  return (
    <div className="flex flex-col items-center justify-center min-h-screen p-6 text-center max-w-md mx-auto">
      <div className="bg-slate-800 p-4 rounded-full mb-6 ring-4 ring-slate-800/50">
        <Github size={48} className="text-white" />
      </div>
      <h1 className="text-2xl font-bold mb-2">GitHub Diff Viewer</h1>
      <p className="text-slate-400 text-sm mb-8">
        Enter a Personal Access Token (repo scope) to view pull requests.
      </p>

      <div className="w-full space-y-4">
        <input
          type="password"
          placeholder="ghp_..."
          value={token}
          onChange={(e) => setToken(e.target.value)}
          className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all"
        />
        <button
          onClick={() => onLogin(token)}
          disabled={!token || loading}
          className="w-full bg-blue-600 hover:bg-blue-500 disabled:opacity-50 disabled:cursor-not-allowed text-white font-medium py-3 rounded-lg flex items-center justify-center gap-2 transition-colors"
        >
          {loading ? <Loader2 className="animate-spin" /> : 'Connect to GitHub'}
        </button>
        {error && (
          <div className="flex items-center gap-2 text-red-400 text-sm bg-red-900/20 p-3 rounded-lg text-left">
            <AlertCircle size={16} className="shrink-0" />
            {error}
          </div>
        )}
      </div>
    </div>
  );
};

const ListView = ({ title, items, onSelect, onBack, loading, renderItem, placeholder }) => {
  const [search, setSearch] = useState('');
  
  const filtered = items.filter(item => 
    JSON.stringify(item).toLowerCase().includes(search.toLowerCase())
  );

  return (
    <div className="flex flex-col h-screen">
      <header className="bg-slate-900 border-b border-slate-800 p-4 sticky top-0 z-10">
        <div className="flex items-center gap-3 mb-4">
          {onBack && (
            <button onClick={onBack} className="p-2 hover:bg-slate-800 rounded-lg transition-colors">
              <ArrowLeft size={20} className="text-slate-400" />
            </button>
          )}
          <h1 className="text-lg font-bold truncate flex-1">{title}</h1>
          {loading && <Loader2 size={20} className="animate-spin text-blue-500" />}
        </div>
        <div className="relative">
          <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" />
          <input 
            type="text"
            placeholder={placeholder || "Search..."}
            value={search}
            onChange={e => setSearch(e.target.value)}
            className="w-full bg-slate-950 border border-slate-800 rounded-lg pl-10 pr-4 py-2 text-sm focus:outline-none focus:border-blue-500 transition-colors"
          />
        </div>
      </header>
      
      <div className="flex-1 overflow-y-auto p-4 space-y-2">
        {loading && items.length === 0 ? (
          <div className="flex flex-col items-center justify-center h-64 text-slate-500 gap-3">
            <Loader2 className="animate-spin" size={32} />
            <p>Loading...</p>
          </div>
        ) : filtered.length === 0 ? (
          <div className="text-center text-slate-500 mt-10">No results found</div>
        ) : (
          filtered.map((item, i) => (
            <button 
              key={i} 
              onClick={() => onSelect(item)}
              className="w-full text-left bg-slate-900/50 hover:bg-slate-800 border border-slate-800 rounded-xl p-4 transition-all active:scale-[0.98]"
            >
              {renderItem(item)}
            </button>
          ))
        )}
      </div>
    </div>
  );
};

const FileSelector = ({ files, selectedIndex, onSelect }) => {
  const [isOpen, setIsOpen] = useState(false);
  const selectedFile = files[selectedIndex] || {};
  const displayFileName = selectedFile.filename ? selectedFile.filename.split('/').pop() : 'Select File';

  return (
    <div className="relative z-20 w-full sm:w-auto">
      <button 
        onClick={() => setIsOpen(!isOpen)}
        className="flex items-center gap-2 px-3 py-2 bg-slate-800 rounded-lg text-slate-200 text-sm font-medium border border-slate-700 active:bg-slate-700 transition-colors w-full justify-between"
      >
        <span className="flex items-center gap-2 truncate">
          <FileCode size={16} className="text-blue-400 shrink-0" />
          <span className="truncate">{displayFileName}</span>
        </span>
        <ChevronDown size={14} className={`shrink-0 transition-transform ${isOpen ? 'rotate-180' : ''}`} />
      </button>

      {isOpen && (
        <>
          <div className="fixed inset-0 z-10" onClick={() => setIsOpen(false)} />
          <div className="absolute top-full left-0 mt-2 w-[90vw] sm:w-96 bg-slate-900 border border-slate-700 rounded-xl shadow-2xl overflow-y-auto max-h-[60vh] py-1 z-20">
            {files.map((file, idx) => (
              <button
                key={file.filename}
                onClick={() => {
                  onSelect(idx);
                  setIsOpen(false);
                }}
                className={`w-full text-left px-4 py-3 text-sm flex items-start gap-3 border-l-2 ${
                  idx === selectedIndex 
                    ? 'bg-blue-500/10 text-blue-400 border-blue-500' 
                    : 'text-slate-300 hover:bg-slate-800 border-transparent'
                }`}
              >
                <div className={`mt-1.5 w-2 h-2 rounded-full shrink-0 ${
                   file.status === 'added' ? 'bg-green-500' : 
                   file.status === 'removed' ? 'bg-red-500' : 'bg-yellow-500'
                }`} />
                <span className="font-medium break-all leading-normal">{file.filename}</span>
              </button>
            ))}
          </div>
        </>
      )}
    </div>
  );
};

const ViewModeToggle = ({ mode, setMode }) => {
  const modes = [
    { id: 'diff', label: 'Diff', icon: GitCommit },
    { id: 'annotated', label: 'Annotated', icon: Code },
    { id: 'original', label: 'Original', icon: Minus },
    { id: 'modified', label: 'Modified', icon: Plus },
  ];

  return (
    <div className="flex bg-slate-900 p-1 rounded-lg border border-slate-700 overflow-x-auto no-scrollbar">
      {modes.map((m) => {
        const isActive = mode === m.id;
        const Icon = m.icon;
        return (
          <button
            key={m.id}
            onClick={() => setMode(m.id)}
            className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium whitespace-nowrap transition-all ${
              isActive 
                ? 'bg-slate-700 text-white shadow-sm' 
                : 'text-slate-400 hover:text-slate-200'
            }`}
          >
            <Icon size={14} />
            {m.label}
          </button>
        );
      })}
    </div>
  );
};

export default function App() {
  // --- URL PARAMS ---
  const params = new URLSearchParams(window.location.search);
  const urlRepo = params.get('repo');
  const urlPr = params.get('pr');

  // --- APP STATE ---
  const [token, setToken] = useState('');
  const [step, setStep] = useState('login'); 
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  // --- DATA STATE ---
  const [repos, setRepos] = useState([]);
  const [selectedRepo, setSelectedRepo] = useState(null);
  const [prs, setPrs] = useState([]);
  const [selectedPR, setSelectedPR] = useState(null);
  const [files, setFiles] = useState([]);
  const [selectedIndex, setSelectedIndex] = useState(0);
  
  // --- VIEW STATE ---
  const [viewMode, setViewMode] = useState('diff');
  // Initialize prefs from local storage
  const [wrapLines, setWrapLines] = useState(() => localStorage.getItem('gh_diff_wrap') !== 'false');
  const [showLineNumbers, setShowLineNumbers] = useState(() => localStorage.getItem('gh_diff_lines') !== 'false');
  const [fileLoading, setFileLoading] = useState(false);
  const [expandedDiffIdx, setExpandedDiffIdx] = useState(null);

  // --- REFS ---
  const scrollRef = useRef(null);
  const scrollRatioRef = useRef(0);
  const firstLoadRef = useRef(true);

  // --- PERSISTENCE & RESTORE ---
  
  useEffect(() => {
    // SAVE STATE
    if (token) localStorage.setItem('gh_diff_token', token);
    if (selectedRepo) localStorage.setItem('gh_diff_repo', JSON.stringify(selectedRepo));
    if (selectedPR) localStorage.setItem('gh_diff_pr', JSON.stringify(selectedPR));
    if (selectedIndex >= 0 && step === 'diff') localStorage.setItem('gh_diff_file_idx', selectedIndex);
    
    // Save prefs
    localStorage.setItem('gh_diff_wrap', wrapLines);
    localStorage.setItem('gh_diff_lines', showLineNumbers);
  }, [token, selectedRepo, selectedPR, selectedIndex, step, wrapLines, showLineNumbers]);

  useEffect(() => {
    // RESTORE STATE OR LOAD URL PARAMS
    const restoreSession = async () => {
      const storedToken = localStorage.getItem('gh_diff_token');
      if (!storedToken) return;

      setLoading(true);
      setToken(storedToken);

      try {
        // CASE A: URL Params exist (Deep Link)
        if (urlRepo && urlPr) {
           await loadPrContext(storedToken, urlRepo, urlPr);
           setLoading(false);
           return; 
        }

        // CASE B: Standard Restore
        // 1. Fetch Repos (Implicit validation)
        const reposData = await fetchGitHub('/user/repos?sort=updated&per_page=100', storedToken);
        setRepos(reposData);
        setStep('repos');

        // 2. Restore Repo
        const savedRepo = JSON.parse(localStorage.getItem('gh_diff_repo'));
        if (!savedRepo) return;
        setSelectedRepo(savedRepo);

        // 3. Fetch PRs
        const prsData = await fetchGitHub(`/repos/${savedRepo.full_name}/pulls?state=open`, storedToken);
        setPrs(prsData);
        setStep('prs');

        // 4. Restore PR
        const savedPR = JSON.parse(localStorage.getItem('gh_diff_pr'));
        if (!savedPR) return;
        
        // Use live PR object if possible
        const activePR = prsData.find(p => p.number === savedPR.number) || savedPR;
        setSelectedPR(activePR);

        // 5. Fetch Files
        const filesData = await fetchGitHub(`/repos/${savedRepo.full_name}/pulls/${activePR.number}/files`, storedToken);
        const formattedFiles = filesData.map(f => ({
            filename: f.filename,
            status: f.status,
            sha: f.sha,
            raw_url: f.raw_url,
            contents_url: f.contents_url,
            original: null,
            modified: null
        }));
        setFiles(formattedFiles);
        setStep('diff');

        // 6. Restore File Index
        const savedIdx = parseInt(localStorage.getItem('gh_diff_file_idx') || '0');
        const validIdx = (formattedFiles[savedIdx]) ? savedIdx : 0;
        setSelectedIndex(validIdx);

        // Trigger fetch for restored file
        if (formattedFiles[validIdx]) {
            fetchFileContent(formattedFiles[validIdx], validIdx, activePR.base.sha, activePR.head.sha, storedToken, savedRepo);
        }

      } catch (e) {
        console.error("Restoration Failed:", e);
        if (e.message === 'Invalid Token') handleLogout();
      } finally {
        setLoading(false);
      }
    };
    restoreSession();
  }, []); // Run once on mount


  // --- HELPER: Load Specific PR Context ---
  const loadPrContext = async (authToken, repoName, prNum) => {
    try {
        setLoading(true);
        // 1. Fetch Repo
        const repoData = await fetchGitHub(`/repos/${repoName}`, authToken);
        setSelectedRepo(repoData);

        // 2. Fetch PR
        const prData = await fetchGitHub(`/repos/${repoName}/pulls/${prNum}`, authToken);
        setSelectedPR(prData);

        // 3. Fetch Files
        const filesData = await fetchGitHub(`/repos/${repoName}/pulls/${prNum}/files`, authToken);
        const formattedFiles = filesData.map(f => ({
            filename: f.filename,
            status: f.status,
            sha: f.sha,
            raw_url: f.raw_url,
            contents_url: f.contents_url,
            original: null,
            modified: null
        }));
        setFiles(formattedFiles);
        setStep('diff');
        setSelectedIndex(0);

        if (formattedFiles.length > 0) {
            await fetchFileContent(formattedFiles[0], 0, prData.base.sha, prData.head.sha, authToken, repoData);
        }
    } catch (e) {
        console.error(e);
        setError(`Failed to load PR ${prNum} from ${repoName}`);
        setStep('repos'); // Fallback to list
        // Try to fetch repos list at least
        const reposData = await fetchGitHub('/user/repos?sort=updated&per_page=100', authToken);
        setRepos(reposData);
    } finally {
        setLoading(false);
    }
  };

  // --- AUTH & NAV ACTIONS ---

  const handleLogin = async (inputToken) => {
    setLoading(true);
    setError(null);
    try {
      setToken(inputToken);
      
      // If we have URL params, try to load that PR directly
      if (urlRepo && urlPr) {
          await loadPrContext(inputToken, urlRepo, urlPr);
      } else {
          // Standard Flow
          const data = await fetchGitHub('/user/repos?sort=updated&per_page=100', inputToken);
          setRepos(data);
          setStep('repos');
      }
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  const handleLogout = () => {
    setToken('');
    setStep('login');
    setRepos([]);
    localStorage.removeItem('gh_diff_token');
    localStorage.removeItem('gh_diff_repo');
    localStorage.removeItem('gh_diff_pr');
    localStorage.removeItem('gh_diff_file_idx');
  };

  const handleSelectRepo = async (repo) => {
    setSelectedRepo(repo);
    setLoading(true);
    try {
      const data = await fetchGitHub(`/repos/${repo.full_name}/pulls?state=open`, token);
      setPrs(data);
      setStep('prs');
    } catch (err) {
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  const handleSelectPR = async (pr) => {
    setSelectedPR(pr);
    setLoading(true);
    try {
      const filesData = await fetchGitHub(`/repos/${selectedRepo.full_name}/pulls/${pr.number}/files`, token);
      const formattedFiles = filesData.map(f => ({
        filename: f.filename,
        status: f.status,
        sha: f.sha,
        raw_url: f.raw_url,
        contents_url: f.contents_url,
        original: null,
        modified: null
      }));

      setFiles(formattedFiles);
      setSelectedIndex(0);
      setStep('diff');
      
      if (formattedFiles.length > 0) {
        fetchFileContent(formattedFiles[0], 0, pr.base.sha, pr.head.sha, token, selectedRepo);
      }

    } catch (err) {
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  // --- CONTENT FETCHING ---
  const fetchFileContent = async (file, index, baseSha, headSha, activeToken = token, activeRepo = selectedRepo) => {
    if (file.original !== null && file.modified !== null) return;

    setFileLoading(true);
    
    try {
      let originalText = '';
      let modifiedText = '';

      if (file.status !== 'added') {
        try {
          const res = await fetchGitHub(`/repos/${activeRepo.full_name}/contents/${file.filename}?ref=${baseSha}`, activeToken);
          if (res.content) originalText = safeDecodeB64(res.content);
        } catch (e) { console.warn("Could not fetch original", e); }
      }

      if (file.status !== 'removed') {
        try {
          const res = await fetchGitHub(`/repos/${activeRepo.full_name}/contents/${file.filename}?ref=${headSha}`, activeToken);
          if (res.content) modifiedText = safeDecodeB64(res.content);
        } catch (e) { console.warn("Could not fetch modified", e); }
      }

      setFiles(prev => {
        const next = [...prev];
        next[index] = { ...next[index], original: originalText, modified: modifiedText };
        return next;
      });

    } catch (err) {
      console.error("Error fetching file content", err);
    } finally {
      setFileLoading(false);
      // Reset first load trigger
      firstLoadRef.current = true;
    }
  };

  useEffect(() => {
    if (step === 'diff' && files[selectedIndex] && selectedPR) {
      const file = files[selectedIndex];
      if (file.original === null || file.modified === null) {
        fetchFileContent(file, selectedIndex, selectedPR.base.sha, selectedPR.head.sha);
      }
      setExpandedDiffIdx(null); // Reset annotations
    }
  }, [selectedIndex]);

  // --- DIFF & NAVIGATION STATE ---
  const currentFile = files[selectedIndex] || { original: '', modified: '' };
  
  const diffData = useMemo(() => {
    if (fileLoading || currentFile.original === null) return [];
    return computeDiff(currentFile.original || '', currentFile.modified || '');
  }, [currentFile, fileLoading]);

  // Identify change blocks for navigation
  const changes = useMemo(() => {
    if (!diffData.length) return [];
    const blocks = [];
    let inChange = false;
    diffData.forEach((chunk, idx) => {
        const isChange = chunk.type !== 'equal';
        if (isChange && !inChange) {
            blocks.push(idx);
            inChange = true;
        } else if (!isChange) {
            inChange = false;
        }
    });
    return blocks;
  }, [diffData]);

  const [currentChangeIndex, setCurrentChangeIndex] = useState(-1);

  // Jump to change logic
  const jumpToChange = (changeIdx) => {
    if (!changes.length) return;
    // Bounds check
    let target = changeIdx;
    if (target < 0) target = 0;
    if (target >= changes.length) target = changes.length - 1;
    
    setCurrentChangeIndex(target);
    const lineIndex = changes[target];
    const el = document.getElementById(`diff-line-${lineIndex}`);
    if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  };

  // Auto-jump on first load
  useEffect(() => {
    if (changes.length > 0 && !fileLoading && firstLoadRef.current) {
        // Short delay to ensure DOM is ready
        setTimeout(() => jumpToChange(0), 100);
        firstLoadRef.current = false; 
    }
  }, [changes, fileLoading]);


  // --- VIEW HELPERS ---

  const handleSetViewMode = (newMode) => {
    if (scrollRef.current) {
      const { scrollTop, scrollHeight, clientHeight } = scrollRef.current;
      scrollRatioRef.current = scrollHeight > clientHeight ? scrollTop / (scrollHeight - clientHeight) : 0;
    }
    setViewMode(newMode);
  };

  useLayoutEffect(() => {
    if (scrollRef.current && scrollRatioRef.current > 0) {
      const { scrollHeight, clientHeight } = scrollRef.current;
      scrollRef.current.scrollTop = scrollRatioRef.current * (scrollHeight - clientHeight);
    }
  }, [viewMode, fileLoading]);

  // Get previous deleted lines for annotation tap
  const getOriginalContent = (index) => {
    let deletedLines = [];
    // Scan backwards from index
    for (let i = index - 1; i >= 0; i--) {
        if (diffData[i].type === 'remove') {
            deletedLines.unshift(diffData[i]);
        } else if (diffData[i].type === 'equal') {
            break;
        }
    }
    return deletedLines;
  };


  /**
   * --- RENDER STEPS ---
   */

  if (step === 'login') return <LoginView onLogin={handleLogin} loading={loading} error={error} />;

  if (step === 'repos') {
    return (
      <ListView 
        title="Repositories" 
        items={repos}
        loading={loading}
        onBack={handleLogout}
        placeholder="Search repositories..."
        renderItem={(repo) => (
          <div className="flex items-center gap-3">
            {repo.private ? <div className="p-2 bg-yellow-500/10 rounded-lg"><Settings size={18} className="text-yellow-500" /></div> 
                          : <div className="p-2 bg-blue-500/10 rounded-lg"><Github size={18} className="text-blue-500" /></div>}
            <div className="flex flex-col">
              <span className="font-semibold text-slate-200">{repo.name}</span>
              <span className="text-xs text-slate-500">{repo.full_name}</span>
            </div>
            <ArrowRight size={16} className="ml-auto text-slate-600" />
          </div>
        )}
        onSelect={handleSelectRepo} 
      />
    );
  }

  if (step === 'prs') {
    return (
      <ListView 
        title={`${selectedRepo?.name}`} 
        items={prs}
        loading={loading}
        onBack={() => setStep('repos')}
        placeholder="Search PRs..."
        renderItem={(pr) => (
          <div className="flex items-start gap-3">
            <div className="mt-1 p-1.5 bg-green-500/10 rounded-full text-green-500">
               <GitPullRequest size={16} />
            </div>
            <div className="flex flex-col min-w-0">
              <span className="font-medium text-slate-200 truncate pr-2">{pr.title}</span>
              <span className="text-xs text-slate-500">#{pr.number} by {pr.user.login}</span>
            </div>
          </div>
        )}
        onSelect={handleSelectPR} 
      />
    );
  }

  // --- DIFF VIEWER RENDER ---
  
  const stats = diffData ? {
    adds: diffData.filter(d => d.type === 'add').length,
    dels: diffData.filter(d => d.type === 'remove').length
  } : { adds: 0, dels: 0 };

  return (
    <div className="flex flex-col h-screen bg-slate-950 text-slate-200 overflow-hidden font-sans">
      
      {/* HEADER */}
      <header className="flex-none bg-slate-900 border-b border-slate-800 shadow-md z-10">
        <div className="flex items-center justify-between p-3 gap-2">
          
          <button onClick={() => setStep('prs')} className="p-2 hover:bg-slate-800 rounded-lg text-slate-400">
            <ArrowLeft size={18} />
          </button>
          
          <div className="flex-1 min-w-0 mx-2">
             <FileSelector files={files} selectedIndex={selectedIndex} onSelect={setSelectedIndex} />
          </div>

          <div className="flex items-center gap-1">
             <button 
              onClick={() => setShowLineNumbers(!showLineNumbers)}
              className={`p-2 rounded-lg transition-colors flex ${showLineNumbers ? 'bg-slate-800 text-slate-400' : 'bg-slate-800 text-slate-600'}`}
            >
              <Hash size={18} />
            </button>
            <button 
              onClick={() => setWrapLines(!wrapLines)}
              className={`p-2 rounded-lg transition-colors ${wrapLines ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-400'}`}
            >
              <WrapText size={18} />
            </button>
             {selectedPR && (
              <button 
                onClick={() => window.open(selectedPR.html_url, '_blank')}
                className="p-2 rounded-lg bg-slate-800 text-slate-400 hover:text-blue-400 transition-colors"
                title="Open in GitHub"
              >
                <ExternalLink size={18} />
              </button>
            )}
          </div>
        </div>

        {/* Bottom Bar: View Modes */}
        <div className="px-3 pb-3 overflow-x-auto">
          <ViewModeToggle mode={viewMode} setMode={handleSetViewMode} />
        </div>
      </header>

      {/* MAIN CONTENT AREA */}
      <main 
        ref={scrollRef}
        className="flex-1 overflow-y-auto relative bg-slate-950 scroll-smooth"
      >
        {fileLoading ? (
          <div className="flex flex-col items-center justify-center h-full text-slate-500 gap-4">
             <Loader2 className="animate-spin text-blue-500" size={32} />
             <p className="text-sm">Fetching file contents...</p>
          </div>
        ) : (
          <div className={`min-h-full pb-20 ${wrapLines ? 'w-full' : 'w-max min-w-full'}`}>
            <div className="pt-2">
               {/* DIFF CONTENT LOGIC */}
               {viewMode === 'diff' && diffData.map((chunk, idx) => {
                  const isAdd = chunk.type === 'add';
                  const isRem = chunk.type === 'remove';
                  let lineClass = "flex border-l-[3px] hover:bg-opacity-10 ";
                  if (isAdd) lineClass += "bg-green-900/20 border-green-500";
                  else if (isRem) lineClass += "bg-red-900/20 border-red-500";
                  else lineClass += "border-transparent hover:bg-slate-800";

                  return (
                    <div key={idx} id={`diff-line-${idx}`} className={lineClass}>
                      {showLineNumbers && (
                        <>
                          <div className="w-8 shrink-0 text-right pr-2 text-[10px] select-none font-mono py-0.5 opacity-50 text-slate-500">{chunk.oldLine}</div>
                          <div className="w-8 shrink-0 text-right pr-2 text-[10px] select-none font-mono py-0.5 opacity-50 text-slate-500">{chunk.newLine}</div>
                        </>
                      )}
                      <div className={`flex-1 px-2 font-mono text-[13px] leading-5 py-0.5 ${wrapLines ? 'whitespace-pre-wrap break-all' : 'whitespace-pre'}`}>
                        <span className="select-none inline-block w-4 opacity-50">{isAdd ? '+' : isRem ? '-' : ''}</span>
                        <SyntaxText text={chunk.text} />
                      </div>
                    </div>
                  );
               })}
               
               {viewMode === 'annotated' && diffData.map((chunk, idx) => {
                  if (chunk.type === 'remove') return null;
                  
                  const isAdd = chunk.type === 'add';
                  const isExpanded = expandedDiffIdx === idx;
                  
                  let originalContent = null;
                  if (isExpanded) {
                      const deleted = getOriginalContent(idx);
                      if (deleted.length > 0) {
                          originalContent = (
                              <div className="bg-red-900/30 border-y border-red-900/50 my-1">
                                  {deleted.map((d, di) => (
                                      <div key={di} className="flex opacity-80">
                                          <div className="w-10 px-2 text-[10px] text-red-400 font-mono select-none">{d.oldLine}</div>
                                          <div className="flex-1 px-3 font-mono text-[13px] text-red-200 line-through decoration-red-500/50">
                                              {d.text}
                                          </div>
                                      </div>
                                  ))}
                              </div>
                          );
                      } else {
                          originalContent = <div className="text-[10px] text-slate-500 px-10 py-1 italic">No previous content (Pure addition)</div>
                      }
                  }

                  return (
                    <div key={idx} id={`diff-line-${idx}`} className="flex flex-col">
                      {originalContent}
                      <div 
                        onClick={() => {
                            if (isAdd) setExpandedDiffIdx(isExpanded ? null : idx);
                        }}
                        className={`flex border-l-[3px] ${isAdd ? 'bg-green-500/10 cursor-pointer active:bg-green-500/20 border-green-500' : 'border-transparent'} hover:bg-slate-800 transition-colors`}
                      >
                        {showLineNumbers && <div className={`w-10 shrink-0 text-right pr-3 text-[10px] py-0.5 text-slate-600 border-r border-slate-800 ${isAdd ? 'text-green-600 font-bold' : ''}`}>{chunk.newLine}</div>}
                        <div className={`flex-1 px-3 font-mono text-[13px] leading-5 py-0.5 ${wrapLines ? 'whitespace-pre-wrap break-all' : 'whitespace-pre'}`}>
                           <SyntaxText text={chunk.text} />
                        </div>
                        {isAdd && (
                            <div className="w-6 shrink-0 flex items-center justify-center text-green-500">
                                {isExpanded ? <RotateCcw size={12} /> : <div className="w-1 bg-green-500 h-full" />}
                            </div>
                        )}
                      </div>
                    </div>
                  );
               })}

               {(viewMode === 'original' || viewMode === 'modified') && (
                 (viewMode === 'original' ? currentFile.original : currentFile.modified)?.split('\n').map((line, idx) => (
                    <div key={idx} className="flex hover:bg-slate-800 group">
                      {showLineNumbers && <div className="w-10 shrink-0 text-right pr-3 text-[10px] py-0.5 text-slate-600 border-r border-slate-800">{idx + 1}</div>}
                      <div className={`flex-1 px-3 font-mono text-[13px] leading-5 py-0.5 ${wrapLines ? 'whitespace-pre-wrap break-all' : 'whitespace-pre'}`}>
                        <SyntaxText text={line} />
                      </div>
                    </div>
                 ))
               )}
            </div>
          </div>
        )}

        {/* Empty State / End of file marker */}
        {!fileLoading && (
          <div className="py-8 text-center opacity-30">
            <GitCommit className="mx-auto mb-2" size={32} />
            <p className="text-xs font-mono">End of file</p>
          </div>
        )}
      </main>

      {/* FOOTER & NAVIGATION CONTROLS */}
      {!fileLoading && changes.length > 0 && (step === 'diff') && (
        <div className="absolute bottom-6 right-4 flex flex-col gap-2 z-20">
             <div className="bg-slate-800/90 backdrop-blur border border-slate-700 rounded-lg shadow-xl flex flex-col overflow-hidden">
                <button 
                  onClick={() => jumpToChange(currentChangeIndex - 1)}
                  disabled={currentChangeIndex <= 0}
                  className="p-3 hover:bg-white/10 disabled:opacity-30 disabled:hover:bg-transparent text-slate-200"
                >
                    <ChevronUp size={20} />
                </button>
                <div className="text-[10px] text-center py-1 font-mono text-slate-400 border-y border-slate-700 bg-black/20">
                    {currentChangeIndex + 1}/{changes.length}
                </div>
                <button 
                   onClick={() => jumpToChange(currentChangeIndex + 1)}
                   disabled={currentChangeIndex >= changes.length - 1}
                   className="p-3 hover:bg-white/10 disabled:opacity-30 disabled:hover:bg-transparent text-slate-200"
                >
                    <ChevronDownIcon size={20} />
                </button>
             </div>
        </div>
      )}

      {(viewMode === 'diff' || viewMode === 'annotated') && !fileLoading && (
        <div className="flex-none bg-slate-900 border-t border-slate-800 p-2 text-[10px] flex justify-center gap-4 text-slate-400">
           <div className="flex items-center gap-1"><div className="w-2 h-2 bg-green-500/50 rounded-full"></div><span>Added ({stats.adds})</span></div>
           {viewMode === 'diff' && <div className="flex items-center gap-1"><div className="w-2 h-2 bg-red-500/50 rounded-full"></div><span>Deleted ({stats.dels})</span></div>}
           {viewMode === 'annotated' && <div className="flex items-center gap-1"><RotateCcw size={10} /><span>Tap green lines to view original</span></div>}
        </div>
      )}
    </div>
  );
}
