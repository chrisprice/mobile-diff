<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GitHub Mobile Diff Viewer</title>

    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#020617">

    <!-- iOS Home Screen Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Diff Viewer">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* Fix for mobile browser address bar */
        .h-screen-dynamic {
            height: 100vh;
            height: 100dvh;
        }
        .min-h-screen-dynamic {
            min-height: 100vh;
            min-height: 100dvh;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-200">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef, useLayoutEffect } = React;

        /**
         * --- ICONS (Replaces lucide-react imports) ---
         */
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
            >
                {children}
            </svg>
        );

        const Menu = (props) => <IconBase {...props}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></IconBase>;
        const X = (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const Settings = (props) => <IconBase {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const FileCode = (props) => <IconBase {...props}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></IconBase>;
        const WrapText = (props) => <IconBase {...props}><line x1="3" x2="21" y1="6" y2="6"/><path d="M3 12h15a3 3 0 1 1 0 6h-4"/><polyline points="16 16 14 18 16 20"/><line x1="3" x2="10" y1="18" y2="18"/></IconBase>;
        const GitCommit = (props) => <IconBase {...props}><circle cx="12" cy="12" r="3"/><line x1="3" x2="9" y1="12" y2="12"/><line x1="15" x2="21" y1="12" y2="12"/></IconBase>;
        const ChevronDown = (props) => <IconBase {...props}><path d="m6 9 6 6 6-6"/></IconBase>;
        const ChevronDownIcon = ChevronDown; // Alias for navigation buttons
        const Minus = (props) => <IconBase {...props}><path d="M5 12h14"/></IconBase>;
        const Plus = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const ArrowRight = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></IconBase>;
        const ArrowLeft = (props) => <IconBase {...props}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></IconBase>;
        const Code = (props) => <IconBase {...props}><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></IconBase>;
        const Hash = (props) => <IconBase {...props}><line x1="4" x2="20" y1="9" y2="9"/><line x1="4" x2="20" y1="15" y2="15"/><line x1="10" x2="8" y1="3" y2="21"/><line x1="16" x2="14" y1="3" y2="21"/></IconBase>;
        const Search = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>;
        const GitPullRequest = (props) => <IconBase {...props}><circle cx="18" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><path d="M13 6h3a2 2 0 0 1 2 2v7"/><line x1="6" x2="6" y1="9" y2="21"/></IconBase>;
        const Loader2 = (props) => <IconBase {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconBase>;
        const Github = (props) => <IconBase {...props}><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/><path d="M9 18c-4.51 2-5-2-7-2"/></IconBase>;
        const AlertCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>;
        const ChevronUp = (props) => <IconBase {...props}><path d="m18 15-6-6-6 6"/></IconBase>;
        const RotateCcw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconBase>;
        const ExternalLink = (props) => <IconBase {...props}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></IconBase>;
        const GitPullRequestCreate = (props) => <IconBase {...props}><circle cx="6" cy="6" r="3"/><path d="M6 9v12"/><circle cx="18" cy="18" r="3"/><path d="M18 9v6"/><path d="M18 3v.01"/></IconBase>;


        /**
         * --- GITHUB API UTILITIES ---
         */
        const GITHUB_API_BASE = 'https://api.github.com';

        const safeDecodeB64 = (str) => {
            try {
                return decodeURIComponent(escape(window.atob(str.replace(/\s/g, ''))));
            } catch (e) {
                console.error("Base64 Decode Error", e);
                return "Error decoding file content. It may be binary.";
            }
        };

        const fetchGitHub = async (endpoint, token) => {
            const response = await fetch(`${GITHUB_API_BASE}${endpoint}`, {
                headers: {
                    Authorization: `token ${token}`,
                    Accept: 'application/vnd.github.v3+json',
                },
            });
            
            if (!response.ok) {
                if (response.status === 401) throw new Error('Invalid Token');
                if (response.status === 403) throw new Error('Rate Limit Exceeded');
                if (response.status === 404) throw new Error('Not Found');
                throw new Error(`GitHub API Error: ${response.status}`);
            }
            return response.json();
        };

        /**
         * --- DIFF ALGORITHM ---
         */
        const computeDiff = (oldText = "", newText = "") => {
            if (!oldText && !newText) return [];

            const lines1 = oldText.split('\n');
            const lines2 = newText.split('\n');

            if (lines1.length > 2000 || lines2.length > 2000) {
                return [{ type: 'equal', text: 'File too large to diff in browser.', oldLine: 1, newLine: 1 }];
            }

            const matrix = Array(lines1.length + 1).fill(null).map(() => Array(lines2.length + 1).fill(0));

            for (let i = 1; i <= lines1.length; i++) {
                for (let j = 1; j <= lines2.length; j++) {
                    if (lines1[i - 1] === lines2[j - 1]) {
                        matrix[i][j] = matrix[i - 1][j - 1] + 1;
                    } else {
                        matrix[i][j] = Math.max(matrix[i - 1][j], matrix[i][j - 1]);
                    }
                }
            }

            const result = [];
            let i = lines1.length, j = lines2.length;

            while (i > 0 || j > 0) {
                if (i > 0 && j > 0 && lines1[i - 1] === lines2[j - 1]) {
                    result.unshift({ type: 'equal', text: lines1[i - 1], oldLine: i, newLine: j });
                    i--; j--;
                } else if (j > 0 && (i === 0 || matrix[i][j - 1] >= matrix[i - 1][j])) {
                    result.unshift({ type: 'add', text: lines2[j - 1], newLine: j });
                    j--;
                } else {
                    result.unshift({ type: 'remove', text: lines1[i - 1], oldLine: i });
                    i--;
                }
            }

            // Post-process to detect adjacent remove/add pairs and compute character-level diffs
            for (let k = 0; k < result.length - 1; k++) {
                const current = result[k];
                const next = result[k + 1];

                // Check if we have a remove followed by an add (line modification)
                if (current.type === 'remove' && next.type === 'add') {
                    const oldLine = current.text;
                    const newLine = next.text;

                    // Only compute char diff if lines are somewhat similar (not completely different)
                    // and not too long (performance)
                    if (oldLine.length < 500 && newLine.length < 500) {
                        const similarity = computeSimilarity(oldLine, newLine);
                        if (similarity > 0.3) {
                            const charDiff = computeCharDiff(oldLine, newLine);
                            if (charDiff) {
                                current.charDiff = charDiff;
                                next.charDiff = charDiff;
                            }
                        }
                    }
                }
            }

            return result;
        };

        // Helper to compute similarity ratio between two strings
        const computeSimilarity = (str1, str2) => {
            const len1 = str1.length;
            const len2 = str2.length;
            if (len1 === 0 || len2 === 0) return 0;

            const maxLen = Math.max(len1, len2);
            let matches = 0;

            for (let i = 0; i < Math.min(len1, len2); i++) {
                if (str1[i] === str2[i]) matches++;
            }

            return matches / maxLen;
        };

        const SyntaxText = ({ text }) => {
            if (!text) return null;
            const parts = text.split(/(\b(?:const|let|var|function|return|if|else|import|from|export|class|div|span|className|style)\b|'.*?'|".*?"|\/\/.*)/g);
            return (
                <React.Fragment>
                {parts.map((part, i) => {
                    if (/^(const|let|var|function|return|if|else|import|from|export|class)$/.test(part)) return <span key={i} className="text-purple-400">{part}</span>;
                    if (/^('.*?'|".*?")$/.test(part)) return <span key={i} className="text-green-400">{part}</span>;
                    if (/^(\/\/.*)$/.test(part)) return <span key={i} className="text-slate-500">{part}</span>;
                    if (/^(div|span|className|style)$/.test(part)) return <span key={i} className="text-blue-400">{part}</span>;
                    return <span key={i}>{part}</span>;
                })}
                </React.Fragment>
            );
        };

        // Character-level diff algorithm using Myers/LCS
        const computeCharDiff = (oldText = "", newText = "") => {
            if (!oldText || !newText) return null;

            // Use a simple character-level LCS to find common subsequences
            const m = oldText.length;
            const n = newText.length;

            // Build LCS matrix
            const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));
            for (let i = 1; i <= m; i++) {
                for (let j = 1; j <= n; j++) {
                    if (oldText[i - 1] === newText[j - 1]) {
                        dp[i][j] = dp[i - 1][j - 1] + 1;
                    } else {
                        dp[i][j] = Math.max(dp[i - 1][j], dp[i][j - 1]);
                    }
                }
            }

            // Backtrack to build segments
            const oldSegments = [];
            const newSegments = [];
            let i = m, j = n;
            let oldBuf = '', newBuf = '';

            while (i > 0 || j > 0) {
                if (i > 0 && j > 0 && oldText[i - 1] === newText[j - 1]) {
                    // Common character
                    if (oldBuf) { oldSegments.unshift({ type: 'change', text: oldBuf }); oldBuf = ''; }
                    if (newBuf) { newSegments.unshift({ type: 'change', text: newBuf }); newBuf = ''; }
                    oldSegments.unshift({ type: 'equal', text: oldText[i - 1] });
                    newSegments.unshift({ type: 'equal', text: newText[j - 1] });
                    i--; j--;
                } else if (j > 0 && (i === 0 || dp[i][j - 1] >= dp[i - 1][j])) {
                    // Addition in new text
                    newBuf = newText[j - 1] + newBuf;
                    j--;
                } else {
                    // Deletion from old text
                    oldBuf = oldText[i - 1] + oldBuf;
                    i--;
                }
            }

            if (oldBuf) oldSegments.unshift({ type: 'change', text: oldBuf });
            if (newBuf) newSegments.unshift({ type: 'change', text: newBuf });

            return { oldSegments, newSegments };
        };

        const DiffText = ({ text, charDiff, isAdd }) => {
            if (!text) return null;

            // If no character diff provided, fall back to syntax highlighting
            if (!charDiff) {
                return <SyntaxText text={text} />;
            }

            const segments = isAdd ? charDiff.newSegments : charDiff.oldSegments;

            return (
                <React.Fragment>
                {segments.map((seg, i) => {
                    if (seg.type === 'change') {
                        return (
                            <span
                                key={i}
                                className={isAdd ? 'bg-green-500/40 text-green-100' : 'bg-red-500/40 text-red-100'}
                            >
                                {seg.text}
                            </span>
                        );
                    }
                    return <span key={i}>{seg.text}</span>;
                })}
                </React.Fragment>
            );
        };

        /**
         * --- COMPONENTS ---
         */

        const LoginView = ({ onLogin, loading, error }) => {
            const [token, setToken] = useState(() => localStorage.getItem('gh_diff_token') || '');
            
            return (
                <div className="flex flex-col items-center justify-center min-h-screen-dynamic p-6 text-center max-w-md mx-auto">
                    <div className="bg-slate-800 p-4 rounded-full mb-6 ring-4 ring-slate-800/50">
                        <Github size={48} className="text-white" />
                    </div>
                    <h1 className="text-2xl font-bold mb-2">GitHub Diff Viewer</h1>
                    <p className="text-slate-400 text-sm mb-8">
                        Enter a Personal Access Token (repo scope) to view pull requests.
                    </p>

                    <div className="w-full space-y-4">
                        <input
                            type="password"
                            placeholder="ghp_..."
                            value={token}
                            onChange={(e) => setToken(e.target.value)}
                            className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all"
                        />
                        <button
                            onClick={() => onLogin(token)}
                            disabled={!token || loading}
                            className="w-full bg-blue-600 hover:bg-blue-500 disabled:opacity-50 disabled:cursor-not-allowed text-white font-medium py-3 rounded-lg flex items-center justify-center gap-2 transition-colors"
                        >
                            {loading ? <Loader2 className="animate-spin" /> : 'Connect to GitHub'}
                        </button>
                        {error && (
                            <div className="flex items-center gap-2 text-red-400 text-sm bg-red-900/20 p-3 rounded-lg text-left">
                                <AlertCircle size={16} className="shrink-0" />
                                {error}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const ListView = ({ title, items, onSelect, onBack, loading, renderItem, placeholder }) => {
            const [search, setSearch] = useState('');
            
            const filtered = items.filter(item => 
                JSON.stringify(item).toLowerCase().includes(search.toLowerCase())
            );

            return (
                <div className="flex flex-col h-screen-dynamic">
                    <header className="bg-slate-900 border-b border-slate-800 p-4 sticky top-0 z-10">
                        <div className="flex items-center gap-3 mb-4">
                            {onBack && (
                                <button onClick={onBack} className="p-2 hover:bg-slate-800 rounded-lg transition-colors">
                                    <ArrowLeft size={20} className="text-slate-400" />
                                </button>
                            )}
                            <h1 className="text-lg font-bold truncate flex-1">{title}</h1>
                            {loading && <Loader2 size={20} className="animate-spin text-blue-500" />}
                        </div>
                        <div className="relative">
                            <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" />
                            <input 
                                type="text"
                                placeholder={placeholder || "Search..."}
                                value={search}
                                onChange={e => setSearch(e.target.value)}
                                className="w-full bg-slate-950 border border-slate-800 rounded-lg pl-10 pr-4 py-2 text-sm focus:outline-none focus:border-blue-500 transition-colors"
                            />
                        </div>
                    </header>
                    
                    <div className="flex-1 overflow-y-auto p-4 space-y-2">
                        {loading && items.length === 0 ? (
                            <div className="flex flex-col items-center justify-center h-64 text-slate-500 gap-3">
                                <Loader2 className="animate-spin" size={32} />
                                <p>Loading...</p>
                            </div>
                        ) : filtered.length === 0 ? (
                            <div className="text-center text-slate-500 mt-10">No results found</div>
                        ) : (
                            filtered.map((item, i) => (
                                <button 
                                    key={i} 
                                    onClick={() => onSelect(item)}
                                    className="w-full text-left bg-slate-900/50 hover:bg-slate-800 border border-slate-800 rounded-xl p-4 transition-all active:scale-[0.98]"
                                >
                                    {renderItem(item)}
                                </button>
                            ))
                        )}
                    </div>
                </div>
            );
        };

        const FileSelector = ({ files, selectedIndex, onSelect }) => {
            const [isOpen, setIsOpen] = useState(false);
            const selectedFile = files[selectedIndex] || {};
            const displayFileName = selectedFile.filename ? selectedFile.filename.split('/').pop() : 'Select File';

            return (
                <div className="relative z-20 w-full sm:w-auto">
                    <button 
                        onClick={() => setIsOpen(!isOpen)}
                        className="flex items-center gap-2 px-3 py-2 bg-slate-800 rounded-lg text-slate-200 text-sm font-medium border border-slate-700 active:bg-slate-700 transition-colors w-full justify-between"
                    >
                        <span className="flex items-center gap-2 truncate">
                            <FileCode size={16} className="text-blue-400 shrink-0" />
                            <span className="truncate">{displayFileName}</span>
                        </span>
                        <ChevronDown size={14} className={`shrink-0 transition-transform ${isOpen ? 'rotate-180' : ''}`} />
                    </button>

                    {isOpen && (
                        <React.Fragment>
                            <div className="fixed inset-0 z-10" onClick={() => setIsOpen(false)} />
                            <div className="absolute top-full left-0 mt-2 w-[90vw] sm:w-96 bg-slate-900 border border-slate-700 rounded-xl shadow-2xl overflow-y-auto max-h-[60vh] py-1 z-20">
                                {files.map((file, idx) => (
                                    <button
                                        key={file.filename}
                                        onClick={() => {
                                            onSelect(idx);
                                            setIsOpen(false);
                                        }}
                                        className={`w-full text-left px-4 py-3 text-sm flex items-start gap-3 border-l-2 ${
                                            idx === selectedIndex 
                                                ? 'bg-blue-500/10 text-blue-400 border-blue-500' 
                                                : 'text-slate-300 hover:bg-slate-800 border-transparent'
                                        }`}
                                    >
                                        <div className={`mt-1.5 w-2 h-2 rounded-full shrink-0 ${
                                            file.status === 'added' ? 'bg-green-500' : 
                                            file.status === 'removed' ? 'bg-red-500' : 'bg-yellow-500'
                                        }`} />
                                        <span className="font-medium break-all leading-normal">{file.filename}</span>
                                    </button>
                                ))}
                            </div>
                        </React.Fragment>
                    )}
                </div>
            );
        };

        const ViewModeToggle = ({ mode, setMode }) => {
            const modes = [
                { id: 'diff', label: 'Diff', icon: GitCommit },
                { id: 'annotated', label: 'Annotated', icon: Code },
                { id: 'original', label: 'Original', icon: Minus },
                { id: 'modified', label: 'Modified', icon: Plus },
            ];

            return (
                <div className="flex bg-slate-900 p-1 rounded-lg border border-slate-700 overflow-x-auto no-scrollbar">
                    {modes.map((m) => {
                        const isActive = mode === m.id;
                        const Icon = m.icon;
                        return (
                            <button
                                key={m.id}
                                onClick={() => setMode(m.id)}
                                className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium whitespace-nowrap transition-all ${
                                    isActive 
                                        ? 'bg-slate-700 text-white shadow-sm' 
                                        : 'text-slate-400 hover:text-slate-200'
                                }`}
                            >
                                <Icon size={14} />
                                {m.label}
                            </button>
                        );
                    })}
                </div>
            );
        };

        const App = () => {
            // --- URL PARAMS ---
            const params = new URLSearchParams(window.location.search);
            const urlRepo = params.get('repo');
            const urlPr = params.get('pr');
            const urlBase = params.get('base');
            const urlHead = params.get('head');

            // --- APP STATE ---
            const [token, setToken] = useState('');
            const [step, setStep] = useState('login'); 
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            // --- DATA STATE ---
            const [repos, setRepos] = useState([]);
            const [selectedRepo, setSelectedRepo] = useState(null);
            const [prs, setPrs] = useState([]);
            const [selectedPR, setSelectedPR] = useState(null);
            const [files, setFiles] = useState([]);
            const [selectedIndex, setSelectedIndex] = useState(0);

            // --- REF DIFF STATE (for comparing refs without a PR) ---
            const [refDiffMode, setRefDiffMode] = useState(false);
            const [baseRef, setBaseRef] = useState(null);
            const [headRef, setHeadRef] = useState(null);
            
            // --- VIEW STATE ---
            const [viewMode, setViewMode] = useState('diff');
            // Initialize prefs from local storage
            const [wrapLines, setWrapLines] = useState(() => localStorage.getItem('gh_diff_wrap') !== 'false');
            const [showLineNumbers, setShowLineNumbers] = useState(() => localStorage.getItem('gh_diff_lines') !== 'false');
            const [fileLoading, setFileLoading] = useState(false);
            const [expandedDiffIdx, setExpandedDiffIdx] = useState(null);

            // --- REFS ---
            const scrollRef = useRef(null);
            const firstLoadRef = useRef(true);

            // --- PERSISTENCE & RESTORE ---
            
            useEffect(() => {
                // SAVE STATE
                if (token) localStorage.setItem('gh_diff_token', token);
                if (selectedRepo) localStorage.setItem('gh_diff_repo', JSON.stringify(selectedRepo));
                if (selectedPR) localStorage.setItem('gh_diff_pr', JSON.stringify(selectedPR));
                if (selectedIndex >= 0 && step === 'diff') localStorage.setItem('gh_diff_file_idx', selectedIndex);
                
                // Save prefs
                localStorage.setItem('gh_diff_wrap', wrapLines);
                localStorage.setItem('gh_diff_lines', showLineNumbers);
            }, [token, selectedRepo, selectedPR, selectedIndex, step, wrapLines, showLineNumbers]);

            useEffect(() => {
                // RESTORE STATE OR LOAD URL PARAMS
                const restoreSession = async () => {
                    const storedToken = localStorage.getItem('gh_diff_token');
                    if (!storedToken) return;

                    setLoading(true);
                    setToken(storedToken);

                    try {
                        // CASE A: URL Params exist (Deep Link)
                        if (urlRepo && urlBase && urlHead) {
                            // Ref diff mode: compare two refs
                            await loadRefDiffContext(storedToken, urlRepo, urlBase, urlHead);
                            setLoading(false);
                            return;
                        }
                        if (urlRepo && urlPr) {
                            await loadPrContext(storedToken, urlRepo, urlPr);
                            setLoading(false);
                            return;
                        }

                        // CASE B: Standard Restore
                        // 1. Fetch Repos
                        const reposData = await fetchGitHub('/user/repos?sort=updated&per_page=100', storedToken);
                        setRepos(reposData);
                        setStep('repos');

                        // 2. Restore Repo
                        const savedRepo = JSON.parse(localStorage.getItem('gh_diff_repo'));
                        if (!savedRepo) return;
                        setSelectedRepo(savedRepo);

                        // 3. Fetch PRs
                        const prsData = await fetchGitHub(`/repos/${savedRepo.full_name}/pulls?state=open`, storedToken);
                        setPrs(prsData);
                        setStep('prs');

                        // 4. Restore PR
                        const savedPR = JSON.parse(localStorage.getItem('gh_diff_pr'));
                        if (!savedPR) return;
                        
                        // Use live PR object if possible
                        const activePR = prsData.find(p => p.number === savedPR.number) || savedPR;
                        setSelectedPR(activePR);

                        // 5. Fetch Files
                        const filesData = await fetchGitHub(`/repos/${savedRepo.full_name}/pulls/${activePR.number}/files`, storedToken);
                        const formattedFiles = filesData.map(f => ({
                            filename: f.filename,
                            status: f.status,
                            sha: f.sha,
                            raw_url: f.raw_url,
                            contents_url: f.contents_url,
                            original: null,
                            modified: null
                        }));
                        setFiles(formattedFiles);
                        setStep('diff');

                        // 6. Restore File Index
                        const savedIdx = parseInt(localStorage.getItem('gh_diff_file_idx') || '0');
                        const validIdx = (formattedFiles[savedIdx]) ? savedIdx : 0;
                        setSelectedIndex(validIdx);

                        // Trigger fetch for restored file
                        if (formattedFiles[validIdx]) {
                            fetchFileContent(formattedFiles[validIdx], validIdx, activePR.base.sha, activePR.head.sha, storedToken, savedRepo);
                        }

                    } catch (e) {
                        console.error("Restoration Failed:", e);
                        if (e.message === 'Invalid Token') handleLogout();
                    } finally {
                        setLoading(false);
                    }
                };
                restoreSession();
            }, []); 


            // --- HELPER: Load Specific PR Context ---
            const loadPrContext = async (authToken, repoName, prNum) => {
                try {
                    setLoading(true);
                    // 1. Fetch Repo
                    const repoData = await fetchGitHub(`/repos/${repoName}`, authToken);
                    setSelectedRepo(repoData);

                    // 2. Fetch PR
                    const prData = await fetchGitHub(`/repos/${repoName}/pulls/${prNum}`, authToken);
                    setSelectedPR(prData);

                    // 3. Fetch Files
                    const filesData = await fetchGitHub(`/repos/${repoName}/pulls/${prNum}/files`, authToken);
                    const formattedFiles = filesData.map(f => ({
                        filename: f.filename,
                        status: f.status,
                        sha: f.sha,
                        raw_url: f.raw_url,
                        contents_url: f.contents_url,
                        original: null,
                        modified: null
                    }));
                    setFiles(formattedFiles);
                    setStep('diff');
                    setSelectedIndex(0);

                    if (formattedFiles.length > 0) {
                        await fetchFileContent(formattedFiles[0], 0, prData.base.sha, prData.head.sha, authToken, repoData);
                    }
                } catch (e) {
                    console.error(e);
                    setError(`Failed to load PR ${prNum} from ${repoName}`);
                    setStep('repos');
                    const reposData = await fetchGitHub('/user/repos?sort=updated&per_page=100', authToken);
                    setRepos(reposData);
                } finally {
                    setLoading(false);
                }
            };

            // --- HELPER: Load Ref Diff Context (comparing two refs) ---
            const loadRefDiffContext = async (authToken, repoName, base, head) => {
                try {
                    setLoading(true);
                    // 1. Fetch Repo
                    const repoData = await fetchGitHub(`/repos/${repoName}`, authToken);
                    setSelectedRepo(repoData);

                    // 2. Store refs and set mode
                    setBaseRef(base);
                    setHeadRef(head);
                    setRefDiffMode(true);
                    setSelectedPR(null);

                    // 3. Use compare API to get files changed between refs
                    const compareData = await fetchGitHub(`/repos/${repoName}/compare/${base}...${head}`, authToken);
                    const formattedFiles = compareData.files.map(f => ({
                        filename: f.filename,
                        status: f.status,
                        sha: f.sha,
                        raw_url: f.raw_url,
                        contents_url: f.contents_url,
                        original: null,
                        modified: null
                    }));
                    setFiles(formattedFiles);
                    setStep('diff');
                    setSelectedIndex(0);

                    if (formattedFiles.length > 0) {
                        await fetchFileContent(formattedFiles[0], 0, compareData.base_commit.sha, compareData.commits[compareData.commits.length - 1]?.sha || head, authToken, repoData);
                    }
                } catch (e) {
                    console.error(e);
                    setError(`Failed to compare ${base}...${head} in ${repoName}`);
                    setStep('repos');
                    const reposData = await fetchGitHub('/user/repos?sort=updated&per_page=100', authToken);
                    setRepos(reposData);
                } finally {
                    setLoading(false);
                }
            };

            // --- AUTH & NAV ACTIONS ---

            const handleLogin = async (inputToken) => {
                setLoading(true);
                setError(null);
                try {
                    setToken(inputToken);

                    if (urlRepo && urlBase && urlHead) {
                        await loadRefDiffContext(inputToken, urlRepo, urlBase, urlHead);
                    } else if (urlRepo && urlPr) {
                        await loadPrContext(inputToken, urlRepo, urlPr);
                    } else {
                        const data = await fetchGitHub('/user/repos?sort=updated&per_page=100', inputToken);
                        setRepos(data);
                        setStep('repos');
                    }
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleLogout = () => {
                setToken('');
                setStep('login');
                setRepos([]);
                localStorage.removeItem('gh_diff_token');
                localStorage.removeItem('gh_diff_repo');
                localStorage.removeItem('gh_diff_pr');
                localStorage.removeItem('gh_diff_file_idx');
            };

            const handleSelectRepo = async (repo) => {
                setSelectedRepo(repo);
                setLoading(true);
                try {
                    const data = await fetchGitHub(`/repos/${repo.full_name}/pulls?state=open`, token);
                    setPrs(data);
                    setStep('prs');
                } catch (err) {
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            };

            const handleSelectPR = async (pr) => {
                setSelectedPR(pr);
                setLoading(true);
                try {
                    const filesData = await fetchGitHub(`/repos/${selectedRepo.full_name}/pulls/${pr.number}/files`, token);
                    const formattedFiles = filesData.map(f => ({
                        filename: f.filename,
                        status: f.status,
                        sha: f.sha,
                        raw_url: f.raw_url,
                        contents_url: f.contents_url,
                        original: null,
                        modified: null
                    }));

                    setFiles(formattedFiles);
                    setSelectedIndex(0);
                    setStep('diff');
                    
                    if (formattedFiles.length > 0) {
                        fetchFileContent(formattedFiles[0], 0, pr.base.sha, pr.head.sha, token, selectedRepo);
                    }

                } catch (err) {
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            };

            // --- CONTENT FETCHING ---
            const fetchFileContent = async (file, index, baseSha, headSha, activeToken = token, activeRepo = selectedRepo) => {
                if (file.original !== null && file.modified !== null) return;

                setFileLoading(true);
                
                try {
                    let originalText = '';
                    let modifiedText = '';

                    if (file.status !== 'added') {
                        try {
                            const res = await fetchGitHub(`/repos/${activeRepo.full_name}/contents/${file.filename}?ref=${baseSha}`, activeToken);
                            if (res.content) originalText = safeDecodeB64(res.content);
                        } catch (e) { console.warn("Could not fetch original", e); }
                    }

                    if (file.status !== 'removed') {
                        try {
                            const res = await fetchGitHub(`/repos/${activeRepo.full_name}/contents/${file.filename}?ref=${headSha}`, activeToken);
                            if (res.content) modifiedText = safeDecodeB64(res.content);
                        } catch (e) { console.warn("Could not fetch modified", e); }
                    }

                    setFiles(prev => {
                        const next = [...prev];
                        next[index] = { ...next[index], original: originalText, modified: modifiedText };
                        return next;
                    });

                } catch (err) {
                    console.error("Error fetching file content", err);
                } finally {
                    setFileLoading(false);
                    firstLoadRef.current = true;
                }
            };

            useEffect(() => {
                if (step === 'diff' && files[selectedIndex]) {
                    const file = files[selectedIndex];
                    if (file.original === null || file.modified === null) {
                        if (refDiffMode && baseRef && headRef) {
                            fetchFileContent(file, selectedIndex, baseRef, headRef);
                        } else if (selectedPR) {
                            fetchFileContent(file, selectedIndex, selectedPR.base.sha, selectedPR.head.sha);
                        }
                    }
                    setExpandedDiffIdx(null);
                }
            }, [selectedIndex]);

            // --- DIFF & NAVIGATION STATE ---
            const currentFile = files[selectedIndex] || { original: '', modified: '' };
            
            const diffData = useMemo(() => {
                if (fileLoading || currentFile.original === null) return [];
                return computeDiff(currentFile.original || '', currentFile.modified || '');
            }, [currentFile, fileLoading]);

            const changes = useMemo(() => {
                if (!diffData.length) return [];
                const blocks = [];
                let inChange = false;
                diffData.forEach((chunk, idx) => {
                    const isChange = chunk.type !== 'equal';
                    if (isChange && !inChange) {
                        blocks.push(idx);
                        inChange = true;
                    } else if (!isChange) {
                        inChange = false;
                    }
                });
                return blocks;
            }, [diffData]);

            const [currentChangeIndex, setCurrentChangeIndex] = useState(-1);

            const jumpToChange = (changeIdx) => {
                if (!changes.length) return;
                let target = changeIdx;
                if (target < 0) target = 0;
                if (target >= changes.length) target = changes.length - 1;

                const lineIndex = changes[target];

                // In annotated mode, removed lines are not rendered, so we need to find
                // the next visible change if the current one is a pure removal
                let elementId = `diff-line-${lineIndex}`;
                let el = document.getElementById(elementId);
                let finalIndex = target;

                if (!el && viewMode === 'annotated') {
                    // Try to find the next visible change in the direction we're moving
                    const direction = target > currentChangeIndex ? 1 : -1;
                    let searchIdx = target + direction;

                    while (!el && searchIdx >= 0 && searchIdx < changes.length) {
                        const searchLineIdx = changes[searchIdx];
                        const searchEl = document.getElementById(`diff-line-${searchLineIdx}`);
                        if (searchEl) {
                            el = searchEl;
                            finalIndex = searchIdx;
                            break;
                        }
                        searchIdx += direction;
                    }
                }

                setCurrentChangeIndex(finalIndex);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            };

            useEffect(() => {
                if (changes.length > 0 && !fileLoading && firstLoadRef.current) {
                    setTimeout(() => jumpToChange(0), 100);
                    firstLoadRef.current = false; 
                }
            }, [changes, fileLoading]);


            // --- VIEW HELPERS ---

            const handleSetViewMode = (newMode) => {
                setViewMode(newMode);
            };

            useLayoutEffect(() => {
                // After mode switch or file load, jump to current hunk if we have one
                if (!fileLoading && currentChangeIndex >= 0 && changes.length > 0) {
                    setTimeout(() => {
                        jumpToChange(currentChangeIndex);
                    }, 50);
                }
            }, [viewMode, fileLoading]);

            const getOriginalContent = (index) => {
                let deletedLines = [];
                for (let i = index - 1; i >= 0; i--) {
                    if (diffData[i].type === 'remove') {
                        deletedLines.unshift(diffData[i]);
                    } else if (diffData[i].type === 'equal') {
                        break;
                    }
                }
                return deletedLines;
            };


            /**
             * --- RENDER STEPS ---
             */

            if (step === 'login') return <LoginView onLogin={handleLogin} loading={loading} error={error} />;

            if (step === 'repos') {
                return (
                    <ListView 
                        title="Repositories" 
                        items={repos}
                        loading={loading}
                        onBack={handleLogout}
                        placeholder="Search repositories..."
                        renderItem={(repo) => (
                            <div className="flex items-center gap-3">
                                {repo.private ? <div className="p-2 bg-yellow-500/10 rounded-lg"><Settings size={18} className="text-yellow-500" /></div> 
                                            : <div className="p-2 bg-blue-500/10 rounded-lg"><Github size={18} className="text-blue-500" /></div>}
                                <div className="flex flex-col">
                                    <span className="font-semibold text-slate-200">{repo.name}</span>
                                    <span className="text-xs text-slate-500">{repo.full_name}</span>
                                </div>
                                <ArrowRight size={16} className="ml-auto text-slate-600" />
                            </div>
                        )}
                        onSelect={handleSelectRepo} 
                    />
                );
            }

            if (step === 'prs') {
                return (
                    <ListView 
                        title={`${selectedRepo?.name}`} 
                        items={prs}
                        loading={loading}
                        onBack={() => setStep('repos')}
                        placeholder="Search PRs..."
                        renderItem={(pr) => (
                            <div className="flex items-start gap-3">
                                <div className="mt-1 p-1.5 bg-green-500/10 rounded-full text-green-500">
                                    <GitPullRequest size={16} />
                                </div>
                                <div className="flex flex-col min-w-0">
                                    <span className="font-medium text-slate-200 truncate pr-2">{pr.title}</span>
                                    <span className="text-xs text-slate-500">#{pr.number} by {pr.user.login}</span>
                                </div>
                            </div>
                        )}
                        onSelect={handleSelectPR} 
                    />
                );
            }

            // --- DIFF VIEWER RENDER ---
            
            const stats = diffData ? {
                adds: diffData.filter(d => d.type === 'add').length,
                dels: diffData.filter(d => d.type === 'remove').length
            } : { adds: 0, dels: 0 };

            return (
                <div className="flex flex-col h-screen-dynamic bg-slate-950 text-slate-200 overflow-hidden font-sans">
                    
                    {/* HEADER */}
                    <header className="flex-none bg-slate-900 border-b border-slate-800 shadow-md z-10">
                        <div className="flex items-center justify-between p-3 gap-2">
                            
                            <button onClick={() => {
                                if (refDiffMode) {
                                    setRefDiffMode(false);
                                    setBaseRef(null);
                                    setHeadRef(null);
                                    setStep('repos');
                                } else {
                                    setStep('prs');
                                }
                            }} className="p-2 hover:bg-slate-800 rounded-lg text-slate-400">
                                <ArrowLeft size={18} />
                            </button>
                            
                            <div className="flex-1 min-w-0 mx-2">
                                <FileSelector files={files} selectedIndex={selectedIndex} onSelect={setSelectedIndex} />
                            </div>

                            <div className="flex items-center gap-1">
                                <button 
                                    onClick={() => setShowLineNumbers(!showLineNumbers)}
                                    className={`p-2 rounded-lg transition-colors flex ${showLineNumbers ? 'bg-slate-800 text-slate-400' : 'bg-slate-800 text-slate-600'}`}
                                >
                                    <Hash size={18} />
                                </button>
                                <button 
                                    onClick={() => setWrapLines(!wrapLines)}
                                    className={`p-2 rounded-lg transition-colors ${wrapLines ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-400'}`}
                                >
                                    <WrapText size={18} />
                                </button>
                                {refDiffMode ? (
                                    <button
                                        onClick={() => window.open(`https://github.com/${selectedRepo.full_name}/compare/${baseRef}...${headRef}?expand=1`, '_blank')}
                                        className="p-2 rounded-lg bg-green-600 text-white hover:bg-green-500 transition-colors"
                                        title="Create Pull Request"
                                    >
                                        <GitPullRequestCreate size={18} />
                                    </button>
                                ) : selectedPR && (
                                    <button
                                        onClick={() => window.open(selectedPR.html_url, '_blank')}
                                        className="p-2 rounded-lg bg-slate-800 text-slate-400 hover:text-blue-400 transition-colors"
                                        title="Open in GitHub"
                                    >
                                        <ExternalLink size={18} />
                                    </button>
                                )}
                            </div>
                        </div>

                        {/* Bottom Bar: View Modes */}
                        <div className="px-3 pb-3 overflow-x-auto">
                            <ViewModeToggle mode={viewMode} setMode={handleSetViewMode} />
                        </div>
                    </header>

                    {/* MAIN CONTENT AREA */}
                    <main 
                        ref={scrollRef}
                        className="flex-1 overflow-y-auto relative bg-slate-950 scroll-smooth"
                    >
                        {fileLoading ? (
                            <div className="flex flex-col items-center justify-center h-full text-slate-500 gap-4">
                                <Loader2 className="animate-spin text-blue-500" size={32} />
                                <p className="text-sm">Fetching file contents...</p>
                            </div>
                        ) : (
                            <div className={`min-h-full pb-20 ${wrapLines ? 'w-full' : 'w-max min-w-full'}`}>
                                <div className="pt-2">
                                    {viewMode === 'diff' && diffData.map((chunk, idx) => {
                                        const isAdd = chunk.type === 'add';
                                        const isRem = chunk.type === 'remove';
                                        let lineClass = "flex border-l-[3px] hover:bg-opacity-10 ";
                                        if (isAdd) lineClass += "bg-green-900/20 border-green-500";
                                        else if (isRem) lineClass += "bg-red-900/20 border-red-500";
                                        else lineClass += "border-transparent hover:bg-slate-800";

                                        return (
                                            <div key={idx} id={`diff-line-${idx}`} className={lineClass}>
                                                {showLineNumbers && (
                                                    <React.Fragment>
                                                        <div className="w-8 shrink-0 text-right pr-2 text-[10px] select-none font-mono py-0.5 opacity-50 text-slate-500">{chunk.oldLine}</div>
                                                        <div className="w-8 shrink-0 text-right pr-2 text-[10px] select-none font-mono py-0.5 opacity-50 text-slate-500">{chunk.newLine}</div>
                                                    </React.Fragment>
                                                )}
                                                <div className={`flex-1 px-2 font-mono text-[13px] leading-5 py-0.5 ${wrapLines ? 'whitespace-pre-wrap break-all' : 'whitespace-pre'}`}>
                                                    <span className="select-none inline-block w-4 opacity-50">{isAdd ? '+' : isRem ? '-' : ''}</span>
                                                    <DiffText text={chunk.text} charDiff={chunk.charDiff} isAdd={isAdd} />
                                                </div>
                                            </div>
                                        );
                                    })}
                                    
                                    {viewMode === 'annotated' && diffData.map((chunk, idx) => {
                                        if (chunk.type === 'remove') return null;

                                        const isAdd = chunk.type === 'add';
                                        const isExpanded = expandedDiffIdx === idx;

                                        let originalContent = null;
                                        if (isExpanded) {
                                            const deleted = getOriginalContent(idx);
                                            if (deleted.length > 0) {
                                                originalContent = (
                                                    <div className="bg-red-900/30 border-y border-red-900/50 my-1">
                                                        {deleted.map((d, di) => (
                                                            <div key={di} className="flex opacity-80">
                                                                {showLineNumbers && <div className="w-10 shrink-0 text-right pr-3 text-[10px] text-red-400 font-mono select-none border-r border-slate-800">{d.oldLine}</div>}
                                                                <div className="flex-1 px-3 font-mono text-[13px] text-red-200 line-through decoration-red-500/50">
                                                                    <DiffText text={d.text} charDiff={d.charDiff} isAdd={false} />
                                                                </div>
                                                                <div className="w-6 shrink-0"></div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                );
                                            } else {
                                                originalContent = <div className="text-[10px] text-slate-500 px-10 py-1 italic">No previous content (Pure addition)</div>
                                            }
                                        }

                                        return (
                                            <div key={idx} id={`diff-line-${idx}`} className="flex flex-col">
                                                {originalContent}
                                                <div
                                                    onClick={() => {
                                                        if (isAdd) setExpandedDiffIdx(isExpanded ? null : idx);
                                                    }}
                                                    className={`flex border-l-[3px] ${isAdd ? 'bg-green-500/10 cursor-pointer active:bg-green-500/20 border-green-500' : 'border-transparent'} hover:bg-slate-800 transition-colors`}
                                                >
                                                    {showLineNumbers && <div className={`w-10 shrink-0 text-right pr-3 text-[10px] py-0.5 text-slate-600 border-r border-slate-800 ${isAdd ? 'text-green-600 font-bold' : ''}`}>{chunk.newLine}</div>}
                                                    <div className={`flex-1 px-3 font-mono text-[13px] leading-5 py-0.5 ${wrapLines ? 'whitespace-pre-wrap break-all' : 'whitespace-pre'}`}>
                                                        <DiffText text={chunk.text} charDiff={chunk.charDiff} isAdd={isAdd} />
                                                    </div>
                                                    {isAdd && (
                                                        <div className="w-6 shrink-0 flex items-center justify-center text-green-500">
                                                            {isExpanded ? <RotateCcw size={12} /> : <div className="w-1 bg-green-500 h-full" />}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })}

                                    {(viewMode === 'original' || viewMode === 'modified') && (
                                        (viewMode === 'original' ? currentFile.original : currentFile.modified)?.split('\n').map((line, idx) => (
                                            <div key={idx} className="flex hover:bg-slate-800 group">
                                                {showLineNumbers && <div className="w-10 shrink-0 text-right pr-3 text-[10px] py-0.5 text-slate-600 border-r border-slate-800">{idx + 1}</div>}
                                                <div className={`flex-1 px-3 font-mono text-[13px] leading-5 py-0.5 ${wrapLines ? 'whitespace-pre-wrap break-all' : 'whitespace-pre'}`}>
                                                    <SyntaxText text={line} />
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        )}

                        {!fileLoading && (
                            <div className="py-8 text-center opacity-30">
                                <GitCommit className="mx-auto mb-2" size={32} />
                                <p className="text-xs font-mono">End of file</p>
                            </div>
                        )}
                    </main>

                    {!fileLoading && changes.length > 0 && (step === 'diff') && (
                        <div className="absolute bottom-6 right-4 flex flex-col gap-2 z-20">
                            <div className="bg-slate-800/90 backdrop-blur border border-slate-700 rounded-lg shadow-xl flex flex-col overflow-hidden">
                                <button 
                                    onClick={() => jumpToChange(currentChangeIndex - 1)}
                                    disabled={currentChangeIndex <= 0}
                                    className="p-3 hover:bg-white/10 disabled:opacity-30 disabled:hover:bg-transparent text-slate-200"
                                >
                                    <ChevronUp size={20} />
                                </button>
                                <div className="text-[10px] text-center py-1 font-mono text-slate-400 border-y border-slate-700 bg-black/20">
                                    {currentChangeIndex + 1}/{changes.length}
                                </div>
                                <button 
                                    onClick={() => jumpToChange(currentChangeIndex + 1)}
                                    disabled={currentChangeIndex >= changes.length - 1}
                                    className="p-3 hover:bg-white/10 disabled:opacity-30 disabled:hover:bg-transparent text-slate-200"
                                >
                                    <ChevronDownIcon size={20} />
                                </button>
                            </div>
                        </div>
                    )}

                    {(viewMode === 'diff' || viewMode === 'annotated') && !fileLoading && (
                        <div className="flex-none bg-slate-900 border-t border-slate-800 p-2 text-[10px] flex justify-center gap-4 text-slate-400">
                            <div className="flex items-center gap-1"><div className="w-2 h-2 bg-green-500/50 rounded-full"></div><span>Added ({stats.adds})</span></div>
                            {viewMode === 'diff' && <div className="flex items-center gap-1"><div className="w-2 h-2 bg-red-500/50 rounded-full"></div><span>Deleted ({stats.dels})</span></div>}
                            {viewMode === 'annotated' && <div className="flex items-center gap-1"><RotateCcw size={10} /><span>Tap green lines to view original</span></div>}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
